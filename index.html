<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="twittler-stylesheet.css">
    <script src="jquery.js"></script>
    <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $stream = $('#stream');
        var newTweets = streams.home.sort(function(a, b) {return b.created_at - a.created_at});
        var lastTweetTime = newTweets[0].created_at;

        addNewTweets();
        setInterval(updateTweetButton, 5000);
        // setTimeout(updateTweetButton, 5000);

        $('button').on('click', function() {
          addNewTweets();
        });

        function addNewTweets() {
          for(var i = newTweets.length - 1; i >= 0; i--) {
            var tweet = newTweets[i];
            var $tweet = $('<div class="tweet"><div class="tweet-header"></div><div class="tweet-content"></div></div>');
            console.log(tweet.created_at.getTime());
            $tweet.find('.tweet-header').text('@' + tweet.user + ' | ' + tweet.created_at);
            $tweet.find('.tweet-content').text(tweet.message);
            $stream.prepend($tweet.hide().fadeIn('slow'));
            // $tweet.prependTo($stream);
          }
          newTweets = [];
          setTweetCount();
        }

        function getLatestTweets() {
          var latest = _.filter(streams.home, function(item) {
            return item.created_at > lastTweetTime;
          });
          if (latest.length > 0) {
            latest.sort(function(a, b) {return b.created_at - a.created_at});
            lastTweetTime = latest[0].created_at;
          }
          return latest;
        }

        function setTweetCount() {
          $('#new-tweets-count').text(newTweets.length);
        };

        function updateTweetButton() {
          var latest = getLatestTweets();
          if (latest.length > 0){
            newTweets = latest.concat(newTweets);
            setTweetCount();
          }
        }

      });

    </script>
    <div>
      <div id="header">
        <div id="page-title">Twittler</div>
        <div id="button-contaier">
          <button name="update"><span id="new-tweets-count">0</span> New Tweets</button>
        </div>
      </div>
      <div id="stream"></div> 
    </div>
  </body>
</html>
